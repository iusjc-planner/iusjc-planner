name: Pull Request Checks

on:
  pull_request:
    branches: [ main, develop ]

jobs:
  # Vérifications rapides pour les PR
  quick-checks:
    name: Quick PR Checks
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      with:
        submodules: recursive

    - name: Check commit messages
      run: |
        # Vérifier le format des messages de commit
        git log --oneline -n 10 --pretty=format:"%s" | while read msg; do
          if [[ ! "$msg" =~ ^(feat|fix|docs|style|refactor|test|chore)(\(.+\))?: .+ ]]; then
            echo " Message de commit non conforme: $msg"
            echo "Format attendu: type(scope): description"
            echo "Types valides: feat, fix, docs, style, refactor, test, chore"
            exit 1
          fi
        done

    - name: Check file changes
      run: |
        # Vérifier qu'il n'y a pas de fichiers sensibles modifiés
        if git diff --name-only origin/main | grep -E "\.(env|key|pem|p12)$"; then
          echo "❌ Fichiers sensibles détectés dans la PR"
          exit 1
        fi

    - name: Check PR size
      run: |
        # Vérifier la taille de la PR
        CHANGED_FILES=$(git diff --name-only origin/main | wc -l)
        if [ $CHANGED_FILES -gt 50 ]; then
          echo "⚠️ PR très volumineuse ($CHANGED_FILES fichiers). Considérez la diviser."
        fi

  # Tests unitaires rapides
  unit-tests:
    name: Unit Tests
    runs-on: ubuntu-latest
    
    strategy:
      matrix:
        component: [backend, frontend]
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      with:
        submodules: recursive

    - name: Backend unit tests
      if: matrix.component == 'backend'
      run: |
        # Tests rapides pour les microservices modifiés
        for service in iusj-auth-service iusj-user-service; do
          if [ -d "$service" ]; then
            echo "Testing $service..."
            cd $service
            ./mvnw test -Dtest="*UnitTest" --batch-mode
            cd ..
          fi
        done

    - name: Frontend unit tests
      if: matrix.component == 'frontend'
      run: |
        if [ -d "frontend" ]; then
          cd frontend
          npm ci
          npm run test:ci
        fi

  # Analyse de code
  code-quality:
    name: Code Quality
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      with:
        submodules: recursive

    - name: Run SonarCloud Scan
      uses: SonarSource/sonarcloud-github-action@master
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        SONAR_TOKEN: ${{ secrets.SONAR_TOKEN }}
      continue-on-error: true

    - name: Comment PR
      uses: actions/github-script@v6
      with:
        script: |
          github.rest.issues.createComment({
            issue_number: context.issue.number,
            owner: context.repo.owner,
            repo: context.repo.repo,
            body: ' Analyse de code terminée. Vérifiez les résultats dans les checks.'
          })